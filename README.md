# Guitar Lesson Review App (RefRet)

ギターレッスンの音源をアップロードし、ボーカル（会話）と楽器（ギター演奏）を分離、会話内容を文字起こし・要約するStreamlitアプリケーションです。


## 機能概要

1.  **音源分離 (Audio Separation)**
    *   **Demucs** (Hybrid Transformer Demucs) モデルを使用。
    *   アップロードされた音源から「ボーカル（会話）」と「ギター/バッキングトラック」を分離します。
    *   **特徴**: ギターのみのトラックを作成する際、単純な引き算ではなく、ドラム・ベース・その他のステムを合成することで、会話の音声をきれいに除去しています。

2.  **文字起こし (Transcription)**
    *   **Faster-Whisper** を使用。
    *   分離されたボーカルトラックから会話内容をテキスト化します。
    *   日本語（`language="ja"`）に最適化された `small` モデルを使用し、高速かつ高精度な認識を実現しています。

3.  **要約 (Summarization)**
    *   **LLM (Large Language Model)** を統合。
    *   文字起こしテキストから、レッスンの要点、登場したコード、練習フレーズなどを抽出・要約します。
    *   **Settingsタブ**から、**OpenAI API** (GPT-4o-mini等) および **Ollama** (ローカルLLM) の切り替えやプロンプトの編集が可能です。

4.  **インタラクティブ・プレイヤー (Study Player)**
    *   **Visual Waveform**: Wavesurfer.js を使用したデュアル波形表示（ボーカル＝紫、ギター＝オレンジ）。
    *   **2トラック同時再生・同期**: ボーカルとギターのトラックが同期して再生されます。
    *   **トラック操作 (Mute/Unmute)**: ボーカル・ギターそれぞれのトラックを個別にミュート/ミュート解除可能。
    *   **A-B ループ**: ギター波形上をドラッグして範囲指定することで、特定フレーズをループ再生できます。ドラッグで範囲作成、クリックで再生位置変更。
    *   **速度調整**: ピッチを変えずに 0.25倍〜1.5倍速まで調整可能。
    *   **インタラクティブな要約**: 要約内のタイムスタンプをクリックすると、該当箇所へプレイヤーがシークします。
    *   **ダウンロード**: 分離されたトラック（MP3）およびオリジナル音源をダウンロード可能。

5.  **ライブラリ管理**
    *   過去に解析したレッスンデータをローカル (`data/`) に保存し、いつでも再確認可能です。

## インストールとセットアップ

### 必要条件
*   Python 3.13 以上
*   [FFmpeg](https://ffmpeg.org/) (システムパスに通っていること)

### インストール手順

1.  リポジトリをクローンまたはダウンロードします。

2.  依存ライブラリをインストールします。
    ```bash
    pip install -r requirements.txt
    ```

3.  (オプション) 環境変数ファイル `.env` を作成しておくと、デフォルト値を設定できます。
    ※ アプリ起動後の「Settings」タブでも設定可能です。
    ```bash
    # .env ファイルの例
    LLM_PROVIDER=openai
    OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxxxxxxxx
    LLM_MODEL=gpt-4o-mini
    ```

### 実行方法

以下のコマンドでアプリケーションを起動します。

```bash
streamlit run app.py
```

ブラウザが立ち上がり、アプリが表示されます。
1. **New Lesson**: 音声ファイルをアップロードして解析を実行。
2. **Library**: 解析結果の確認、プレイヤーでの学習。
3. **Settings**: APIキーやプロンプトの設定。

## トラブルシューティング

*   **依存関係エラー**: `soundfile` や `av` 関連のエラーが出る場合は、OSのライブラリ不足の可能性があります（Macの場合は `brew install ffmpeg` 等を確認）。
*   **分離に時間がかかる**: Demucsの処理はCPU負荷が高いです。初回実行時はモデルのダウンロードも行われます。
